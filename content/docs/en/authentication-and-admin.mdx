---
title: Admin Roles & Authorization
description: Configure read-only and read/write admin roles, protect admin APIs, and understand the authentication pipeline used by this template.
keywords:
  - authentication
  - RBAC
  - admin
  - roles
  - authorization
  - Next.js
  - Better Auth
  - Drizzle ORM
tags: [auth, roles, admin]
author: "Pansa Legrand"
publishedAt: "2025-09-29T00:00:00.000Z"
updatedAt: "2025-09-29T00:00:00.000Z"
canonical: "https://sushi-saas-template.io/en/blogs/authentication-and-admin"
---

# Authentication & Admin

This template uses Better Auth + Drizzle for authentication and sessions. A simple, DB‑backed RBAC layer adds two admin roles on top of regular users. Roles are stored in the database only (no env-based elevation).

## Auth Pipeline Overview

- Library: Better Auth (`src/lib/auth.ts`) with Drizzle adapter to Postgres (`src/db/schema.ts`).
- Users are stored in `users`. Sessions, accounts, and verifications live in `sessions`, `accounts`, `verifications`.
- The session is fetched in App Router via `auth.api.getSession({ headers })`.
- Custom user fields are exposed to the session via `additionalFields` (we include `uuid` and `role`).

## Roles

- `user`: default for everyone.
- `admin_ro`: read‑only admin; can list users, list orders, and view a user’s credit summary.
- `admin_rw`: read + operation admin; includes all read‑only powers and can grant credits to users (`trans_type = system_add`).

Table changes (migration `0001_add_user_role.sql`) add `users.role` with default `user`.

## How Authorization Works

- Helpers in `src/lib/authz.ts` derive the current user’s role from the session/DB only:
  - `requireAdminRead()` → allows `admin_ro`/`admin_rw`.
  - `requireAdminWrite()` → allows `admin_rw`.

## Admin APIs

All endpoints are server‑only and role‑guarded:

- `GET /api/admin/users` → list users. Query: `page`, `limit`.
- `GET /api/admin/orders` → list paid orders. Query: `page`, `limit`.
- `GET /api/admin/users/:uuid/credits` → credit summary + recent ledger.
- `POST /api/admin/credits/grant` → grant credits as `system_add`.

```jsonc
// POST /api/admin/credits/grant body
{
  "userUuid": "<target-user-uuid>",
  "credits": 100,
  "expiredAt": null,     // optional ISO string or null
  "orderNo": "",         // optional
  "note": "promo Q4"     // reserved for future auditing
}
```

## Setup Steps

1) Migrate DB

Run migrations to add the `role` column:

```bash
pnpm drizzle-kit generate --config src/db/config.ts
pnpm drizzle-kit migrate --config src/db/config.ts
```

This repo includes `src/db/migrations/0001_add_user_role.sql` so a generate is optional if you don’t change the schema further.

2) Verify endpoints

- Call `GET /api/admin/users` as an admin to confirm access.
- Call `POST /api/admin/credits/grant` with a target `userUuid` to add credits; the ledger shows `trans_type = system_add`.

## Changing Roles

Update roles in the database (authoritative source):

- SQL (direct):
  ```sql
  update users set role = 'admin_rw' where uuid = '<uuid>';
  ```
- Update via code helper:
  - `updateUserRole(uuid, 'admin_ro' | 'admin_rw' | 'user')` in `src/models/user.ts`.

## Notes & Tips

- The existing dev endpoint `POST /api/account/credits/grant` is for local testing; lock it down or remove in production in favor of the admin endpoint above.
- Consider adding an audit log table if you need to track who granted credits (operator UUID, timestamp, reason).
- Protect admin accounts with MFA/SSO and shorter session TTLs.
- Only expose admin UI/pages after guarding them on the server (check role in the server component and redirect if unauthorized).
- Roles are not controlled by environment variables; use DB changes for assignment/revocation.

## Social Sign‑In (Google)

- The Google provider is configured in `src/lib/auth.ts` under `socialProviders.google` and reads `GOOGLE_CLIENT_ID` / `GOOGLE_CLIENT_SECRET` from `.env`.
- Ensure these envs are set: `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`, plus `BETTER_AUTH_URL` and `NEXT_PUBLIC_AUTH_BASE_URL` (e.g. `http://localhost:3000` in development).
- In Google Cloud Console → Credentials, add the Authorized redirect URI:
  - `http://localhost:3000/api/auth/callback/google` (dev)
  - `https://your-domain.com/api/auth/callback/google` (prod)
- The login screen at `/[locale]/login` shows a “Continue with Google” button that starts the OAuth flow.

## Email & Password

This template enables Better Auth’s email & password authenticator and includes localized “Forgot password” and “Reset password” pages.

- Server config lives in `src/lib/auth.ts` → `emailAndPassword` is enabled and wired with `sendResetPassword` and `onPasswordReset` callbacks.
- Emails are sent via Resend using `src/services/email/send.ts` and the template `src/services/email/templates/reset-password.tsx`.
- UI routes are localized under the App Router:
  - `/[locale]/forgot-password` → request reset link
  - `/[locale]/reset-password?token=...` → set new password
- All UI strings come from `messages/*.json` under the `auth.*` namespace (see `messages/en.json`).

### Client usage

```ts
// Request a reset link
await authClient.requestPasswordReset({
  email: "john.doe@example.com",
  redirectTo: "/en/reset-password", // locale-aware in app
});

// Reset password (token comes from the reset link)
await authClient.resetPassword({
  newPassword: "newpassword1234",
  token,
});
```

### Pages & Components

- Components: `src/components/auth/forgot-password-form.tsx`, `src/components/auth/reset-password-form.tsx` (client components; i18n with `next-intl`).
- Pages: thin wrappers at `src/app/[locale]/(auth)/forgot-password/page.tsx` and `src/app/[locale]/(auth)/reset-password/page.tsx` render the components.

### Environment

- Required: `BETTER_AUTH_URL`, `RESEND_API_KEY`, `EMAIL_FROM`.
- Optional: `NEXT_PUBLIC_AUTH_BASE_URL` for client in edge cases.

### Manual check

1. Visit `/[locale]/forgot-password`, submit a known user email.
2. Open the email and follow the link to `reset-password?token=...`.
3. Set a new password and sign in at `/[locale]/login`.
