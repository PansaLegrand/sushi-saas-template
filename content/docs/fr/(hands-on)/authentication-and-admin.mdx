---
title: Authentification & Admin
icon: "Shield"
description: Configurer des rôles admin en lecture seule et lecture/écriture, protéger les APIs admin et comprendre le pipeline d’authentification.
keywords:
  - authentification
  - RBAC
  - admin
  - rôles
  - autorisation
  - Next.js
  - Better Auth
  - Drizzle ORM
tags: [auth, rôles, admin]
author: "Pansa Legrand"
publishedAt: "2025-09-29T00:00:00.000Z"
updatedAt: "2025-09-29T00:00:00.000Z"
canonical: "https://www.sushi-templates.com/fr/blogs/authentication-and-admin"
---

# Authentification & Admin

Ce template utilise Better Auth + Drizzle. Le RBAC est stocké en base de données, sans élévation via des variables d’environnement.

## Rôles

- `user` : rôle par défaut.
- `admin_ro` : lecture seule ; lister les utilisateurs/commandes et voir les crédits d’un utilisateur.
- `admin_rw` : lecture + opérations ; peut aussi accorder des crédits (`trans_type = system_add`).

La migration `0001_add_user_role.sql` ajoute `users.role` avec la valeur par défaut `user`.

## Autorisation

- `src/lib/authz.ts` lit le rôle depuis la session/BD :
  - `requireAdminRead()` → autorise `admin_ro`/`admin_rw`.
  - `requireAdminWrite()` → autorise `admin_rw`.

## APIs Admin

- `GET /api/admin/users` → liste des utilisateurs (pagination `page`, `limit`).
- `GET /api/admin/orders` → commandes payées (pagination).
- `GET /api/admin/users/:uuid/credits` → résumé des crédits.
- `POST /api/admin/credits/grant` → accorde des crédits (`system_add`).

## Mise en place

1) Migrer la base :

```bash
pnpm drizzle-kit migrate --config src/db/config.ts
```

2) Vérifier les endpoints (avec un compte admin).

## Modifier les rôles

La base de données est la source d’autorité :

- SQL :
  ```sql
  update users set role = 'admin_rw' where uuid = '<uuid>';
  ```
- Helper :
  - `updateUserRole(uuid, 'admin_ro' | 'admin_rw' | 'user')` dans `src/models/user.ts`.

## Remarques

- Protéger les comptes admin (MFA/SSO) et réduire la durée des sessions.
- Protéger les pages admin côté serveur et rediriger si non autorisé.
- Pas de rôles via .env ; utilisez la base pour assigner/révoquer.

## Connexion sociale (Google)

- Le provider Google est configuré dans `src/lib/auth.ts` sous `socialProviders.google` et lit `GOOGLE_CLIENT_ID` / `GOOGLE_CLIENT_SECRET` depuis `.env`.
- Vérifiez les variables : `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`, ainsi que `BETTER_AUTH_URL` et `NEXT_PUBLIC_AUTH_BASE_URL` (ex. `http://localhost:3000` en dev).
- Dans Google Cloud Console → Identifiants, ajoutez l’URI de redirection autorisée :
  - `http://localhost:3000/api/auth/callback/google` (dev)
  - `https://votre-domaine.com/api/auth/callback/google` (prod)
- L’écran `/[locale]/login` affiche un bouton “Continuer avec Google” qui lance le flux OAuth.
