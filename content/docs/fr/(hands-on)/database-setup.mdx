---
title: Mise en place de la base de donn√©es
icon: "Database"
description: Pr√©parer Postgres et Drizzle ORM pour Better Auth et les tables de l‚Äôapplication.
keywords:
  - Postgres
  - Drizzle ORM
  - migrations
  - Better Auth
  - sch√©ma
  - Next.js
  - base de donn√©es
tags: [base de donn√©es, Drizzle, Postgres]
author: "Pansa Legrand"
publishedAt: "2025-09-29T00:00:00.000Z"
updatedAt: "2025-09-29T00:00:00.000Z"
canonical: "https://sushi-saas-template.io/fr/blogs/database-setup"
---

Avant d‚Äôutiliser les nouvelles pages d‚Äôauthentification, il faut une base de
donn√©es pr√™te. Ce guide d√©taille l‚ÄôORM livr√© (Drizzle), les sc√©narios possibles,
les fichiers √† modifier et les commandes √† lancer ensuite.

## 1. Qu‚Äôest-ce que Drizzle ORM ?

Nous utilisons **[Drizzle ORM](https://orm.drizzle.team/)** comme couche typ√©e
entre TypeScript et Postgres. Le sch√©ma dans `src/db/schema.ts` fait foi. Depuis
ce fichier nous pouvons :

- G√©n√©rer des migrations SQL avec `drizzle-kit`
- Ex√©cuter ces migrations sur Postgres
- Partager des types dans tout le projet (ex. `users.$inferSelect`)

Inutile d‚Äô√©crire du SQL √† la main : modifiez le sch√©ma et laissez Drizzle g√©rer
les migrations.

## 2. Choisir votre sc√©nario base de donn√©es

Adaptez la configuration √† votre contexte et mettez `.env` √† jour.

| Sc√©nario | Recommandation |
| --- | --- |
| **D√©veloppement local uniquement** | Lancer Postgres via Docker (ex. `docker run ... postgres:16`) et pointer `DATABASE_URL` sur `postgres://postgres:postgres@localhost:5432/postgres`. |
| **Postgres manag√© (Neon, Supabase, Railway, Render‚Ä¶)** | Utiliser la cha√Æne de connexion fournie et autoriser l‚Äôadresse IP depuis laquelle vous ex√©cutez les migrations. |
| **Une base diff√©rente par environnement** | Conserver `.env` pour le local et stocker les secrets de production directement dans votre h√©bergeur. |
| **Base existante avec d‚Äôautres tables** | Drizzle ne touchera qu‚Äôaux tables d√©finies dans `src/db/schema.ts`. V√©rifiez qu‚Äôil n‚Äôy ait pas de collision de noms ou utilisez un sch√©ma d√©di√©. |

> Astuce : Drizzle ne cr√©e pas la base de donn√©es. Cr√©ez-la au pr√©alable (UI du
> fournisseur ou `psql`).

## 3. Configurer les variables d‚Äôenvironnement

D√©finissez la cha√Æne Postgres et les secrets Better Auth. Le projet lit `.env`,
`.env.local` et `.env.development`.

```bash  title=".env"
DATABASE_URL="postgresql://user:password@host:5432/db?sslmode=require"
BETTER_AUTH_SECRET="$(openssl rand -base64 32)"
BETTER_AUTH_URL="http://localhost:3000"
```

Red√©marrez `pnpm dev` apr√®s chaque modification pour recharger ces valeurs.

## 4. Comprendre les fichiers de sch√©ma

- `src/db/schema.ts` ‚Äì mod√®les Drizzle pour **Better Auth** (`users`, `sessions`,
  `accounts`, `verifications`) et les tables m√©tier (`orders`, `credits`, etc.).
- `src/db/config.ts` ‚Äì configuration drizzle-kit (chemin du sch√©ma + URL
  Postgres).
- `src/lib/auth.ts` ‚Äì correspondance des champs Better Auth avec les colonnes
  Drizzle. √Ä adapter si vous renommez des colonnes dans `users`.

Ajoutez vos colonnes/tables dans `schema.ts` puis ajustez `auth.ts` si
n√©cessaire.

## 5. G√©n√©rer une migration apr√®s chaque modification

D√®s que `schema.ts` change :

```bash
pnpm drizzle-kit generate --config src/db/config.ts
```

Exemple de sortie :

```
Reading config file 'src/db/config.ts'
...
[‚úì] Your SQL migration file ‚ûú src/db/migrations/0002_add_user_flag.sql üöÄ
```

Deux fichiers sont cr√©√©s :

- `src/db/migrations/<timestamp>_*.sql`
- `src/db/migrations/meta/_journal.json`

Commitez-les.

## 6. Appliquer les migrations

Poussez le SQL vers Postgres :

```bash
pnpm drizzle-kit migrate --config src/db/config.ts
```

Sortie attendue :

```
Applying migrations from src/db/migrations
Migration 0002_add_user_flag.sql executed in 380 ms
All migrations applied!
```

Si la commande √©choue, v√©rifiez `DATABASE_URL`, vos droits r√©seau ou que votre
instance Postgres tourne toujours.

## 7. V√©rifier le r√©sultat

Inspectez les tables avec l‚Äôoutil de votre choix. Exemple `psql` :

```sql
\dt
SELECT * FROM sessions LIMIT 1;
SELECT email_verified FROM users LIMIT 1;
```

Vous devriez voir les tables Better Auth et les nouvelles colonnes.

## 8. Tester le flux d‚Äôauthentification

Apr√®s les migrations, red√©marrez `pnpm dev`, ouvrez `/fr/signup` (ou votre
locale) et cr√©ez un utilisateur. Vous serez redirig√© vers l‚Äôaccueil et les
lignes `users` / `sessions` seront cr√©√©es.

## 9. D√©pannage

- **Error: model "userss" not found** ‚Äì Assurez-vous que `src/lib/auth.ts`
  utilise bien `users`; supprimez `usePlural` si besoin.
- **Colonne manquante** ‚Äì Vous avez modifi√© `schema.ts` mais oubli√© `generate`
  et `migrate`.
- **Impossible de se connecter** ‚Äì V√©rifiez l‚Äôexistence de la base, le couple
  login/mot de passe et les r√®gles r√©seau.
- **Repartir de z√©ro** ‚Äì Supprimez les tables √† la main ou rejouez le SQL
  inverse, puis reg√©n√©rez.

Respectez toujours la boucle : modifier ‚Üí g√©n√©rer ‚Üí migrer ‚Üí v√©rifier. Ainsi, vos
pages d‚Äôauthentification resteront stables.
