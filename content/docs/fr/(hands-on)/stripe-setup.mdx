---
title: Configuration Stripe
icon: "CreditCard"
description: Utilisez Stripe Checkout pour les paiements et finalisez via webhook pour octroyer des crédits. Configurez les variables d’environnement, créez des sessions, gérez les callbacks et traitez les événements signés.
keywords:
  - Stripe
  - Checkout
  - webhook
  - paiements
  - crédits
  - Next.js
  - facturation
tags: [Stripe, paiements, webhook]
author: "Pansa Legrand"
publishedAt: "2025-09-29T00:00:00.000Z"
updatedAt: "2025-09-29T00:00:00.000Z"
canonical: "https://sushi-saas-template.io/fr/blogs/stripe-setup"
---

## Aperçu

Le template utilise Stripe Checkout pour les paiements et un registre de crédits pour accorder du solde après l’achat.

- UI : `/[locale]/pricing` lit les plans depuis un fichier TypeScript typé.
- Création de session : le client envoie `POST /api/checkout` puis est redirigé vers Stripe.
- Retour : Stripe renvoie l’utilisateur vers `/api/pay/callback/stripe` (GET).
- Finalisation serveur : Stripe envoie un webhook sur `/api/pay/webhook/stripe` (POST) qui marque la commande payée et crédite le compte.

Le webhook est la source de vérité ; le callback ne fait que rediriger.

---

## Endpoints

- `/api/checkout` (POST) : valide le plan (`src/data/pricing.ts`), crée la session, enregistre une `order` `created`.
- `/api/pay/callback/stripe` (GET) : redirection post‑Stripe ; ne finalise plus la commande.
- `/api/pay/webhook/stripe` (POST) : vérifie la signature et traite `checkout.session.completed` pour marquer `paid` et créditer.

---

## Crédits

1) Récupération de `order_no` depuis les métadonnées de la session.
2) Mise à jour de la commande en `paid` + détails de paiement.
3) Ajout d’une ligne positive dans `credits` (`order_pay`).

---

## Pré-requis

```bash
STRIPE_PRIVATE_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...
NEXT_PUBLIC_WEB_URL=http://localhost:3000
NEXT_PUBLIC_PAY_CANCEL_URL=/pricing
NEXT_PUBLIC_PAY_SUCCESS_URL=/pricing
NEXT_PUBLIC_PAY_FAIL_URL=/pricing
```

---

## Webhook local

```bash
stripe login
stripe listen --forward-to localhost:3000/api/pay/webhook/stripe
stripe trigger checkout_session_completed
```

---

## Essayer

1) Créez un compte et connectez‑vous.
2) Ouvrez `/[locale]/pricing` et choisissez un plan.
3) Carte de test : `4242 4242 4242 4242`.
4) Redirection vers le callback ; le webhook confirme et crédite.
5) Vérifiez `/[locale]/credits-test` ou `POST /api/account/credits`.

---

## Détails d’implémentation

- Plans : `src/data/pricing.ts`.
- `handleCheckoutSession` gère paiement unique et abonnement (PaymentIntent via `latest_invoice`).

---

## Produits vs Prix (Stripe)

Stripe dissocie le catalogue (ce que vous vendez) de la tarification (comment c’est facturé) :

- Produit (`prod_...`) : nom/description, métadonnées catalogue ; un produit peut avoir plusieurs prix.
- Prix (`price_...`) : devise, montant, récurrence (mois/an), essais, comportement fiscal, paliers. Les abonnements s’attachent à un Prix.

Pourquoi référencer des IDs de Prix en Checkout

- Un abonnement nécessite des conditions tarifaires exactes. S’attacher à `price_...` permet les renouvellements corrects, le prorrata, les essais et Stripe Tax.
- Les renouvellements référencent le même `price_...` sur les lignes de facture, ce qui permet au webhook d’identifier le plan et d’accorder les crédits à chaque cycle.
- Plus sûr que des prix « ad‑hoc » : gérez montants/règles dans Stripe, le code reste stable.

Où trouver vos IDs de Prix dans Stripe

1) Dashboard → Produits → choisissez un produit.
2) Dans le tableau des Prix, cliquez sur les 3 points au bout de la ligne → « Copier l’ID du prix ».
3) Il commence par `price_...` — ne pas confondre avec l’ID produit (`prod_...`).

Variables d’environnement (optionnel mais recommandé)

```bash
# Faites correspondre vos plans aux Prix Stripe ; à défaut, fallback en price_data inline
NEXT_PUBLIC_STRIPE_PRICE_LAUNCH_MONTHLY=price_...
NEXT_PUBLIC_STRIPE_PRICE_SCALE_MONTHLY=price_...
NEXT_PUBLIC_STRIPE_PRICE_LAUNCH_YEARLY=price_...
NEXT_PUBLIC_STRIPE_PRICE_SCALE_YEARLY=price_...
# Variantes CNY (optionnel)
NEXT_PUBLIC_STRIPE_PRICE_LAUNCH_MONTHLY_CNY=price_...
NEXT_PUBLIC_STRIPE_PRICE_SCALE_MONTHLY_CNY=price_...
NEXT_PUBLIC_STRIPE_PRICE_LAUNCH_YEARLY_CNY=price_...
NEXT_PUBLIC_STRIPE_PRICE_SCALE_YEARLY_CNY=price_...
```

Comportement avec/sans IDs de Prix

- Si un plan d’abonnement possède un Price ID, Checkout l’utilise directement.
- Sinon, Checkout crée la session avec `price_data` inline depuis `src/data/pricing.ts` (repli sûr).

---

## Renouvellements et Crédits

Les renouvellements sont gérés automatiquement :

- Webhook `invoice.payment_succeeded` (avec `billing_reason=subscription_cycle`) crée une commande de renouvellement et accorde les crédits du plan pour la période.
- Idempotence : on saute si une commande existe déjà pour `(subscription_id, period_start)`.
- L’achat initial reste géré par `checkout.session.completed` ; pour éviter le double crédit, les factures hors cycle sont ignorées.

---

---

## Facturation et Abonnements

### Portail Client

Activez le Customer Portal de Stripe et choisissez ce que vos clients peuvent gérer (annuler/reprendre, mettre à jour la carte, consulter les factures).

Dans ce template :

- API : `GET /api/billing/portal` — crée une session du portail et redirige vers Stripe
- UI : `/:locale/account/billing` — bouton « Manage billing » qui ouvre le portail

Implémentation :

- Route API : `src/app/api/billing/portal/route.ts`
  - Recherche ou crée un Customer Stripe via l’email de l’utilisateur connecté
  - Crée une session de portail avec `return_url` vers `/:locale/account/billing`

Côté interface (Server Component) :

- `src/app/[locale]/account/billing/page.tsx` pointe vers `/api/billing/portal?locale=<locale>`

### Relance (Paiements échoués)

Webhook : `invoice.payment_failed` déclenche un email demandant la mise à jour du moyen de paiement (via Resend).

- Template : `src/services/email/templates/payment-failed.tsx`
- Envoi : `sendPaymentFailedEmail()` dans `src/services/email/send.ts`
- Webhook : voir `src/app/api/pay/webhook/stripe/route.ts`

Test local avec Stripe CLI :

```bash
stripe trigger invoice_payment_failed
```

Remarque : l’email inclut un lien vers `/:locale/account/billing` pour ouvrir le portail depuis l’app.

---

## Rappel : redirigez les webhooks en test

En local (ou toute URL hors production), assurez‑vous que Stripe redirige les événements vers votre backend ; sinon le paiement aboutit mais la commande/les crédits ne sont pas finalisés :

```bash
stripe listen --forward-to localhost:3000/api/pay/webhook/stripe
```

Si vous utilisez un domaine/tunnel distant, redirigez vers cette URL au lieu de localhost.
