---
title: æ•°æ®åº“é…ç½®
icon: "Database"
description: ä½¿ç”¨ Postgres ä¸ Drizzle ORM ä¸º Better Auth å’Œä¸šåŠ¡è¡¨æ­å»ºæ•°æ®å±‚ã€‚
keywords:
  - Postgres
  - Drizzle ORM
  - è¿ç§»
  - Better Auth
  - æ¨¡å‹
  - Next.js
  - æ•°æ®åº“
tags: [database, Drizzle, Postgres]
author: "Pansa Legrand"
publishedAt: "2025-09-29T00:00:00.000Z"
updatedAt: "2025-09-29T00:00:00.000Z"
canonical: "https://www.sushi-templates.com/zh/blogs/database-setup"
---

æ•°æ®åº“æ˜¯ç°ä»£ SaaS çš„ä¸­å¿ƒã€‚å‡ ä¹æ‰€æœ‰èƒ½åŠ›â€”â€”è®¤è¯ã€è®¡è´¹ã€ç§¯åˆ†ã€å­˜å‚¨ã€ç”¨é‡è¿½è¸ªï¼Œç”šè‡³æ¼”ç¤ºæ¨¡å—â€”â€”éƒ½ä¼šè½åˆ°æ•°æ®åº“ã€‚æˆ‘ä»¬æœ‰æ—¶è‡ªå˜²æ˜¯â€œCRUD å·¥ç¨‹å¸ˆâ€ï¼šå¢åˆ æ”¹æŸ¥æ˜¯æ—¥å¸¸å·¥ä½œã€‚éšç€ schema å˜å¤§ï¼ŒæŠŠæ•°æ®åº“å½“ä½œåœ°åŸºï¼Œèƒ½è®©åº”ç”¨ä¿æŒå¯é¢„æœŸã€‚

æœ¬æ–‡å°†æ•°æ®åº“æ”¾åœ¨é¦–ä½ï¼šå…ˆè®²è¡¨å¦‚ä½•æ˜ å°„åˆ°åŠŸèƒ½ï¼Œå†è®²å¦‚ä½•ç”¨ Drizzle åšç±»å‹å®‰å…¨çš„ CRUDï¼Œæœ€åè®²è¿æ¥ã€è¿ç§»ä¸éªŒè¯ã€‚

## ä¸ºä»€ä¹ˆæ•°æ®åº“è¦å…ˆè¡Œ

- äº‹å®æ¥æºï¼šauthã€è®¡è´¹ã€æ–‡ä»¶ã€ä»»åŠ¡éƒ½æŒä¹…åŒ–åœ¨æ­¤ï¼Œå¹¶åœ¨æœåŠ¡/API å±‚åšå…³è”æŸ¥è¯¢ã€‚
- æ¨¡å‹ â†’ ç±»å‹ â†’ UIï¼š`src/db/schema.ts` ä¸­çš„ Drizzle æ¨¡å‹äº§å‡ºçš„ç±»å‹ä¼šåœ¨æ¨¡å‹ä¸è·¯ç”±ä¸­å…±äº«ã€‚
- CRUD å³äº§å“ç•Œé¢ï¼šå¤§å¤šæ•°é¡µé¢æœ¬è´¨ä¸Šæ˜¯åˆ—è¡¨/è¯¦æƒ…çš„è¯»å†™ã€‚è¡¨è®¾è®¡å¾—å¥½ï¼ŒUI å°±å®¹æ˜“äº¤ä»˜ã€‚

### å…³é”®åŸŸï¼ˆè¡¨ â†’ åŠŸèƒ½ï¼‰

- è®¤è¯ï¼š`users`ã€`sessions`ã€`accounts`ã€`verifications`ï¼ˆBetter Authï¼‰ã€‚
- è®¡è´¹ä¸ç§¯åˆ†ï¼š`orders`ã€`credits` è®°å½•è´­ä¹°ä¸ç§¯åˆ†æµæ°´ã€‚
- å­˜å‚¨ï¼š`files` ä¿å­˜ S3/R2 å¯¹è±¡å…ƒæ•°æ®ä¸ç”Ÿå‘½å‘¨æœŸï¼ˆuploading â†’ active â†’ deletedï¼‰ã€‚
- ç”¨é‡ä¸ä»»åŠ¡ï¼ˆAIï¼‰ï¼š`tasks` è®°å½• queued/running/completedï¼Œå¹¶ä»¥ `credits_trans_no` å…³è”åˆ°ç§¯åˆ†è´¦æœ¬ã€‚
- å†…å®¹ï¼š`posts`ã€‚
- å¢é•¿ä¸åé¦ˆï¼š`affiliates`ã€`feedbacks`ã€‚
- æ¼”ç¤ºï¼š`reservation_services`ã€`reservations` å±•ç¤ºæ’æœŸ/è®¢é‡‘æ”¯ä»˜æ¨¡å¼ã€‚

### ä»£ç ä¸­çš„ CRUD ä¼˜å…ˆæ¨¡å¼

- æ¨¡å‹ä½äº `src/models/*`ï¼Œæä¾›ç±»å‹åŒ–çš„ helperï¼š
  - `src/models/file.ts`ï¼š`insertFile`ã€`findFileByUuid`ã€`updateFileByUuid`ã€`listFilesByUser`ã€`softDeleteFile`ã€‚
  - `src/models/task.ts`ï¼š`insertTask`ã€`findTaskByUuid`ã€`getTasksByUserUuid`ã€`updateTaskStatus`ã€‚
- æœåŠ¡ä¸ API è·¯ç”±è°ƒç”¨è¿™äº› helperï¼›å°½é‡é›†ä¸­æ•°æ®åº“è®¿é—®ï¼Œé¿å…æ•£è½æŸ¥è¯¢ã€‚
- æ–°åŠŸèƒ½è·¯å¾„ï¼šåœ¨ `src/db/schema.ts` å»ºè¡¨/åŠ åˆ— â†’ `pnpm drizzle-kit generate` â†’ `pnpm drizzle-kit migrate` â†’ æ·»åŠ  `src/models/<domain>.ts` â†’ åœ¨ `src/services/*` ä¸è·¯ç”±ä¸­ä½¿ç”¨ã€‚

## 1. ä»€ä¹ˆæ˜¯ Drizzle ORMï¼Ÿ

**[Drizzle ORM](https://orm.drizzle.team/)** æ˜¯è¿æ¥ TypeScript ä¸ Postgres çš„ç±»å‹å®‰å…¨å±‚ã€‚`src/db/schema.ts` ä¸­çš„å®šä¹‰å°±æ˜¯å”¯ä¸€æ•°æ®æºï¼Œå®ƒè®©æˆ‘ä»¬å¯ä»¥ï¼š

- é€šè¿‡ `drizzle-kit` ç”Ÿæˆè¿ç§» SQL
- å°†è¿ç§»æ‰§è¡Œåˆ° Postgres
- åœ¨é¡¹ç›®ä¸­å…±äº«ç±»å‹ï¼ˆä¾‹å¦‚ `users.$inferSelect`ï¼‰

æ— éœ€æ‰‹å†™ SQLï¼Œç›´æ¥ä¿®æ”¹ schema æ–‡ä»¶ï¼Œå†è®© Drizzle è´Ÿè´£ç”Ÿæˆå’Œæ‰§è¡Œè¿ç§»å³å¯ã€‚

## 2. é€‰æ‹©ä½ çš„æ•°æ®åº“æ–¹æ¡ˆ

æ ¹æ®å®é™…æƒ…å†µæ›´æ–° `.env`ã€‚

| åœºæ™¯ | å»ºè®® |
| --- | --- |
| **ä»…æœ¬åœ°å¼€å‘** | ä½¿ç”¨ Docker å¯åŠ¨ Postgresï¼ˆå¦‚ `docker run ... postgres:16`ï¼‰ï¼Œ`DATABASE_URL` æŒ‡å‘ `postgres://postgres:postgres@localhost:5432/postgres`ã€‚ |
| **æ‰˜ç®¡ Postgresï¼ˆNeonã€Supabaseã€Railway ç­‰ï¼‰** | ä½¿ç”¨æœåŠ¡å•†æä¾›çš„è¿æ¥ä¸²ï¼Œå¹¶å…è®¸æ‰§è¡Œè¿ç§»çš„ IP è®¿é—®ã€‚ |
| **ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒæ•°æ®åº“** | `.env` ä¿ç•™æœ¬åœ°é…ç½®ï¼Œç”Ÿäº§ç¯å¢ƒåœ¨éƒ¨ç½²å¹³å°ä¸­é…ç½®ç›¸åŒçš„ç¯å¢ƒå˜é‡ã€‚ |
| **å·²æœ‰æ•°æ®åº“å¹¶å«å…¶å®ƒè¡¨** | Drizzle åªä¼šä¿®æ”¹ `src/db/schema.ts` å£°æ˜çš„è¡¨ã€‚ç¡®è®¤æ²¡æœ‰å‘½åå†²çªï¼Œå¿…è¦æ—¶å¯ä»¥ä½¿ç”¨ç‹¬ç«‹ schemaã€‚ |

> æ³¨æ„ï¼šDrizzle ä¸ä¼šè‡ªåŠ¨åˆ›å»ºæ•°æ®åº“ï¼Œè¯·å…ˆæ‰‹åŠ¨åˆ›å»ºç©ºåº“å†æ‰§è¡Œè¿ç§»ã€‚

## 3. é…ç½®ç¯å¢ƒå˜é‡

è®¾ç½®è¿æ¥å­—ç¬¦ä¸²å’Œ Better Auth çš„å¯†é’¥ã€‚é¡¹ç›®é»˜è®¤è¯»å– `.env`ã€`.env.local`ã€`.env.development`ã€‚

```bash  title=".env"
DATABASE_URL="postgresql://user:password@host:5432/db?sslmode=require"
BETTER_AUTH_SECRET="$(openssl rand -base64 32)"
BETTER_AUTH_URL="http://localhost:3000"
```

ä¿®æ”¹ååŠ¡å¿…é‡å¯ `pnpm dev`ï¼Œç¡®ä¿è¿›ç¨‹è¯»å–æœ€æ–°å€¼ã€‚

## 4. ç†è§£ç›¸å…³æ–‡ä»¶

- `src/db/schema.ts` â€“ å®šä¹‰ **Better Auth** çš„æ ¸å¿ƒè¡¨ï¼ˆ`users`ã€`sessions`ã€`accounts`ã€`verifications`ï¼‰ä»¥åŠä¸šåŠ¡è¡¨ï¼š`orders`ã€`credits`ã€`files`ã€`tasks`ã€`posts`ã€`affiliates`ã€`feedbacks`ã€`reservation_services`ã€`reservations`ã€‚
- `src/db/config.ts` â€“ drizzle-kit çš„é…ç½®ï¼ˆschema è·¯å¾„å’Œ Postgres è¿æ¥ï¼‰ã€‚
- `src/lib/auth.ts` â€“ Better Auth å­—æ®µä¸ Drizzle åˆ—çš„æ˜ å°„ã€‚å¦‚æœé‡å‘½åäº† `users` çš„åˆ—ï¼Œè¿™é‡Œä¹Ÿè¦è°ƒæ•´ã€‚

æ·»åŠ åˆ—æˆ–è¡¨æ—¶ï¼Œå…ˆæ”¹ `schema.ts`ï¼Œå†åŒæ­¥æ›´æ–° `auth.ts` ä¸­çš„æ˜ å°„ã€‚å»ºè®®åœ¨ `schema.ts` ä¸­ä¸ºé«˜é¢‘æŸ¥è¯¢æ·»åŠ ç´¢å¼•ï¼ˆ`uniqueIndex`/`index`ï¼‰ï¼Œä»¥ä¾¿æ•°æ®å¢å¤§åä»èƒ½ä¿æŒè¯»å–æ€§èƒ½ã€‚

## 5. ä»£ç å˜æ›´åç”Ÿæˆè¿ç§»

æ¯æ¬¡ä¿®æ”¹ `schema.ts` éƒ½éœ€è¦æ‰§è¡Œï¼š

```bash
pnpm drizzle-kit generate --config src/db/config.ts
```

ç¤ºä¾‹è¾“å‡ºï¼š

```
Reading config file 'src/db/config.ts'
...
[âœ“] Your SQL migration file âœ src/db/migrations/0002_add_user_flag.sql ğŸš€
```

ä¼šç”Ÿæˆï¼š

- `src/db/migrations/<timestamp>_*.sql`
- `src/db/migrations/meta/_journal.json`

è¯·æŠŠå®ƒä»¬éƒ½æäº¤åˆ°ç‰ˆæœ¬åº“ã€‚

## 6. å°†è¿ç§»åº”ç”¨åˆ° Postgres

æ‰§è¡Œç”Ÿæˆå¥½çš„ SQLï¼š

```bash
pnpm drizzle-kit migrate --config src/db/config.ts
```

æˆåŠŸè¾“å‡ºç¤ºä¾‹ï¼š

```
Applying migrations from src/db/migrations
Migration 0002_add_user_flag.sql executed in 380 ms
All migrations applied!
```

å¦‚é‡è®¤è¯å¤±è´¥ï¼Œæ£€æŸ¥ `DATABASE_URL`ï¼›è‹¥è¶…æ—¶æˆ–å¡ä½ï¼Œç¡®è®¤ç½‘ç»œæƒé™æˆ–æ•°æ®åº“æ˜¯å¦å¯åŠ¨ã€‚

## 7. éªŒè¯ç»“æœ

ä½¿ç”¨ä»»æ„ Postgres å®¢æˆ·ç«¯æ£€æŸ¥è¡¨å’Œåˆ—ã€‚`psql` ç¤ºä¾‹ï¼š

```sql
\dt
SELECT * FROM sessions LIMIT 1;
SELECT email_verified FROM users LIMIT 1;
```

ä½ åº”è¯¥èƒ½çœ‹åˆ° Better Auth çš„è¡¨ä»¥åŠæ ¸å¿ƒä¸šåŠ¡è¡¨ã€‚åšä¸€ä¸ªæœ€å° CRUD çƒŸæµ‹ï¼šé€šè¿‡ä¸€ä¸ªæ¨¡å‹ helper æ’å…¥å¹¶è¯»å–ä¸€è¡Œï¼ˆä¾‹å¦‚ï¼Œè°ƒç”¨ `POST /api/storage/uploads` åˆ›å»ºä¸€æ¡ `files` è®°å½•ï¼Œç„¶å `SELECT * FROM files LIMIT 1;`ï¼‰ã€‚

## 8. ä½“éªŒè®¤è¯æµç¨‹

è¿ç§»å®Œæˆåï¼Œé‡å¯ `pnpm dev`ï¼Œæ‰“å¼€ `/zh/signup`ï¼ˆæˆ–å…¶å®ƒè¯­è¨€è·¯å¾„ï¼‰æ³¨å†Œè´¦å·ã€‚æˆåŠŸæ³¨å†Œåä¼šè·³å›é¦–é¡µï¼Œå¹¶èƒ½åœ¨ `users`ã€`sessions` è¡¨ä¸­çœ‹åˆ°æ–°è®°å½•ã€‚

## 9. å¸¸è§é—®é¢˜æ’æŸ¥

- **Error: model "userss" not found** â€“ ç¡®è®¤ `src/lib/auth.ts` ä¸­å¼•ç”¨çš„æ˜¯ `users` è¡¨ï¼Œç§»é™¤æ—§ç¤ºä¾‹é‡Œçš„ `usePlural`ã€‚ 
- **ç¼ºå°‘åˆ—** â€“ ä¿®æ”¹äº† `schema.ts` å´æ²¡æœ‰æ‰§è¡Œ `generate` å’Œ `migrate`ã€‚è¯·é‡æ–°æ‰§è¡Œã€‚ 
- **è¿æ¥å¤±è´¥** â€“ ç¡®è®¤æ•°æ®åº“å­˜åœ¨ã€è´¦å·å¯†ç æ­£ç¡®ã€SSL/ç½‘ç»œç­–ç•¥å…è®¸è®¿é—®ã€‚ 
- **éœ€è¦æ¸…ç©ºæ•°æ®** â€“ æ‰‹åŠ¨åˆ é™¤è¡¨æˆ–ä½¿ç”¨ drizzle-kit ç”Ÿæˆçš„ SQL å›æ»šï¼Œç„¶åé‡æ–° `generate` â†’ `migrate`ã€‚

éµå¾ªã€Œä¿®æ”¹ä»£ç  â†’ ç”Ÿæˆè¿ç§» â†’ æ‰§è¡Œè¿ç§» â†’ éªŒè¯ã€çš„æµç¨‹ï¼Œå°±èƒ½é¿å…è®¤è¯æ¥å£è¿”å› 500 é”™è¯¯ã€‚
