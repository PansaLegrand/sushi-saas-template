---
title: Autenticación y Admin
icon: "Shield"
description: Configura roles de administrador de solo lectura y lectura/escritura, protege las APIs de admin y entiende el flujo de autenticación del template.
keywords:
  - autenticación
  - RBAC
  - administrador
  - roles
  - autorización
  - Next.js
  - Better Auth
  - Drizzle ORM
tags: [auth, roles, admin]
author: "Pansa Legrand"
publishedAt: "2025-09-29T00:00:00.000Z"
updatedAt: "2025-09-29T00:00:00.000Z"
canonical: "https://sushi-saas-template.io/es/blogs/authentication-and-admin"
---

# Autenticación y Admin

Este template usa Better Auth + Drizzle. El control de acceso (RBAC) se basa en la base de datos, sin elevación por variables de entorno.

## Roles

- `user`: por defecto.
- `admin_ro`: solo lectura; puede listar usuarios, pedidos y ver créditos de un usuario.
- `admin_rw`: lectura + operaciones; además puede otorgar créditos (`trans_type = system_add`).

La migración `0001_add_user_role.sql` añade `users.role` con valor por defecto `user`.

## Autorización

- `src/lib/authz.ts` obtiene el rol desde la sesión/BD:
  - `requireAdminRead()` → permite `admin_ro`/`admin_rw`.
  - `requireAdminWrite()` → permite `admin_rw`.

## Endpoints de Admin

- `GET /api/admin/users` → lista de usuarios (paginación `page`, `limit`).
- `GET /api/admin/orders` → pedidos pagados (paginación).
- `GET /api/admin/users/:uuid/credits` → resumen de créditos.
- `POST /api/admin/credits/grant` → otorga créditos como `system_add`.

## Pasos de configuración

1) Migrar BD:

```bash
pnpm drizzle-kit migrate --config src/db/config.ts
```

2) Verificar endpoints (con una cuenta admin).

## Cambiar roles

Usa la base de datos como fuente de verdad:

- SQL:
  ```sql
  update users set role = 'admin_rw' where uuid = '<uuid>';
  ```
- Helper de código:
  - `updateUserRole(uuid, 'admin_ro' | 'admin_rw' | 'user')` en `src/models/user.ts`.

## Notas

- Protege cuentas admin con MFA/SSO y sesiones más cortas.
- Asegura páginas de admin en componentes de servidor y redirige si no hay permisos.
- Los roles no se configuran por .env; cámbialos en la BD.

## Inicio de sesión social (Google)

- El proveedor está configurado en `src/lib/auth.ts` dentro de `socialProviders.google` y toma `GOOGLE_CLIENT_ID` / `GOOGLE_CLIENT_SECRET` de `.env`.
- Asegúrate de definir: `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`, y también `BETTER_AUTH_URL` y `NEXT_PUBLIC_AUTH_BASE_URL` (por ejemplo `http://localhost:3000` en desarrollo).
- En Google Cloud Console → Credentials, añade la URI de redirección autorizada:
  - `http://localhost:3000/api/auth/callback/google` (dev)
  - `https://tu-dominio.com/api/auth/callback/google` (prod)
- La pantalla `/[locale]/login` muestra un botón “Continuar con Google” que inicia el flujo OAuth.
