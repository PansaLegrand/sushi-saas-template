---
title: Configuraci√≥n de la base de datos
icon: "Database"
description: Configura Postgres y Drizzle ORM ‚Äî la columna vertebral para auth, cobros, almacenamiento, tareas y tablas de la app.
keywords:
  - Postgres
  - Drizzle ORM
  - migraciones
  - Better Auth
  - esquema
  - Next.js
  - base de datos
tags: [base de datos, Drizzle, Postgres]
author: "Pansa Legrand"
publishedAt: "2025-09-29T00:00:00.000Z"
updatedAt: "2025-09-29T00:00:00.000Z"
canonical: "https://www.sushi-templates.com/es/blogs/database-setup"
---

La base de datos es el centro de un SaaS moderno. Casi todo ‚Äîautenticaci√≥n, cobros, cr√©ditos, almacenamiento, seguimiento de uso e incluso m√≥dulos de demo‚Äî pasa por la BD. A veces decimos en broma que somos ‚Äúingenieros CRUD‚Äù: crear, leer, actualizar, borrar es el trabajo diario. A medida que el esquema crece, tratar la BD como la base mantiene la app predecible.

Esta gu√≠a pone la BD primero: mapea el esquema a funcionalidades, explica el CRUD tipado con Drizzle y luego c√≥mo conectar, migrar y validar.

## Por qu√© la base va primero

- Sistema de registro: auth, cobros, archivos y tareas se persisten aqu√≠ y se cruzan en servicios/APIs.
- Esquema ‚Üí Tipos ‚Üí UI: los modelos de Drizzle en `src/db/schema.ts` generan tipos seguros que se comparten por modelos y rutas.
- CRUD como superficie de producto: la mayor√≠a de pantallas son listas/detalles de lectura/escritura. Un buen dise√±o de tablas acelera la UI.

### Dominios clave (tablas ‚Üí funcionalidades)

- Auth: `users`, `sessions`, `accounts`, `verifications` para Better Auth.
- Cobros y cr√©ditos: `orders`, `credits` registran compras y movimientos de cr√©dito.
- Almacenamiento: `files` guarda metadatos S3/R2 y ciclo de vida (uploading ‚Üí active ‚Üí deleted).
- Uso y tareas (IA): `tasks` registra queued/running/completed con `credits_trans_no` enlazado al libro mayor.
- Contenido: `posts` para snapshots de contenido.
- Crecimiento y feedback: `affiliates`, `feedbacks`.
- Demo: `reservation_services`, `reservations` muestran patrones de agenda/pagos.

### Patrones centrados en CRUD en el c√≥digo

- Modelos en `src/models/*` con helpers tipados:
  - `src/models/file.ts`: `insertFile`, `findFileByUuid`, `updateFileByUuid`, `listFilesByUser`, `softDeleteFile`.
  - `src/models/task.ts`: `insertTask`, `findTaskByUuid`, `getTasksByUserUuid`, `updateTaskStatus`.
- Servicios y rutas API llaman estos helpers; centraliza el acceso a la BD.
- Para a√±adir una feature: tablas en `src/db/schema.ts` ‚Üí `pnpm drizzle-kit generate` ‚Üí `pnpm drizzle-kit migrate` ‚Üí `src/models/<dominio>.ts` ‚Üí uso en `src/services/*` y rutas.

## 1. ¬øQu√© es Drizzle ORM?

Usamos **[Drizzle ORM](https://orm.drizzle.team/)** como capa tipada entre
TypeScript y Postgres. El esquema en `src/db/schema.ts` es la √∫nica fuente de
verdad. Desde ese archivo podemos:

- Generar migraciones SQL con `drizzle-kit`
- Ejecutar migraciones contra Postgres
- Compartir tipos en toda la app (por ejemplo `users.$inferSelect`)

No edites SQL a mano; modifica el esquema y deja que Drizzle cree y aplique las
migraciones.

## 2. Elige tu escenario de base de datos

No existe una configuraci√≥n √∫nica. Escoge el escenario que mejor encaje y
actualiza `.env`.

| Escenario | Recomendaci√≥n |
| --- | --- |
| **Solo desarrollo local** | Ejecuta Postgres con Docker (por ejemplo `docker run ... postgres:16`) y apunta `DATABASE_URL` a `postgres://postgres:postgres@localhost:5432/postgres`. |
| **Postgres gestionado (Neon, Supabase, Railway, Render...)** | Copia la cadena de conexi√≥n del proveedor y aseg√∫rate de permitir la IP desde la que ejecutas migraciones. |
| **BD diferente por entorno** | Usa `.env` para desarrollo local y configura los secretos de producci√≥n directamente en tu hosting. |
| **Base de datos existente con otras tablas** | Drizzle solo modificar√° las tablas declaradas en `src/db/schema.ts`. Comprueba que no haya conflictos de nombres o crea un schema distinto. |

> Consejo: Drizzle no crea la base de datos. Crea la BD vac√≠a antes de lanzar
> las migraciones.

## 3. Configura las variables de entorno

Define la cadena de conexi√≥n y los secretos de Better Auth. Leemos `.env`,
`.env.local` y `.env.development` por defecto.

```bash  title=".env"
DATABASE_URL="postgresql://user:password@host:5432/db?sslmode=require"
BETTER_AUTH_SECRET="$(openssl rand -base64 32)"
BETTER_AUTH_URL="http://localhost:3000"
```

Reinicia `pnpm dev` despu√©s de cambiar cualquier valor para que el proceso los
recargue.

## 4. Conoce los archivos del esquema

- `src/db/schema.ts` ‚Äì modelos Drizzle para **Better Auth** (`users`, `sessions`,
  `accounts`, `verifications`) y tablas propias: `orders`, `credits`, `files`,
  `tasks`, `posts`, `affiliates`, `feedbacks`, `reservation_services`,
  `reservations`.
- `src/db/config.ts` ‚Äì configuraci√≥n de drizzle-kit que apunta al esquema y a la
  URL de Postgres.
- `src/lib/auth.ts` ‚Äì mapea los campos de Better Auth hacia las columnas Drizzle.
  Actualiza este archivo si renombras columnas en `users`.

Cuando necesites nuevas columnas o tablas, modifica `schema.ts` y, si aplica, el mapeo correspondiente en `auth.ts`. A√±ade √≠ndices en `schema.ts` (`uniqueIndex`/`index`) para mantener lecturas r√°pidas cuando crezca el volumen.

## 5. Genera migraciones tras cambiar c√≥digo

Cada vez que cambie `schema.ts`, ejecuta:

```bash
pnpm drizzle-kit generate --config src/db/config.ts
```

Salida esperada (ejemplo):

```
Reading config file 'src/db/config.ts'
...
[‚úì] Your SQL migration file ‚ûú src/db/migrations/0002_add_user_flag.sql üöÄ
```

El comando crea dos archivos:

- `src/db/migrations/<timestamp>_*.sql` ‚Äì el SQL que se ejecutar√°
- `src/db/migrations/meta/_journal.json` ‚Äì el registro de migraciones

Acu√©rdate de a√±adir ambos archivos al control de versiones.

## 6. Aplica las migraciones a Postgres

Ejecuta el SQL generado sobre la base de datos:

```bash
pnpm drizzle-kit migrate --config src/db/config.ts
```

Ejemplo de √©xito:

```
Applying migrations from src/db/migrations
Migration 0002_add_user_flag.sql executed in 380 ms
All migrations applied!
```

Si ves errores de autenticaci√≥n, revisa `DATABASE_URL`. Si el comando se queda
colgado o caduca, verifica permisos de red o que el contenedor est√© encendido.

## 7. Valida el resultado

Usa cualquier cliente Postgres para inspeccionar las tablas/columnas. Con `psql`:

```sql
\dt
SELECT * FROM sessions LIMIT 1;
SELECT email_verified FROM users LIMIT 1;
```

Deber√≠as ver las tablas de Better Auth y las tablas n√∫cleo de la app. Como smoke test de CRUD, inserta y lee una fila con un helper del modelo (p. ej., crea un `files` m√≠nimo v√≠a `POST /api/storage/uploads`, luego `SELECT * FROM files LIMIT 1;`).

## 8. Prueba el flujo de autenticaci√≥n

Despu√©s de aplicar las migraciones, reinicia `pnpm dev`, abre `/es/signup` (o la
ruta con tu locale) y crea un usuario. Deber√≠as volver a la home y ver registros
nuevos en `users` y `sessions`.

## 9. Soluci√≥n de problemas

- **Error: model "userss" not found** ‚Äì Comprueba que `src/lib/auth.ts`
  referencia la tabla correcta (`users`). Elimina `usePlural` si lo copiaste de
  ejemplos antiguos.
- **Falta una columna al iniciar sesi√≥n** ‚Äì Cambiaste `schema.ts` pero olvidaste
  ejecutar `generate` + `migrate`. Vuelve a generarlas.
- **No se puede conectar a la base de datos** ‚Äì Confirma que la BD existe, las
  credenciales son correctas y que la red permite conexiones.
- **Necesito borrar todo** ‚Äì Elimina las tablas manualmente o usa el SQL de
  drizzle-kit para revertirlas antes de volver a ejecutar `generate` y
  `migrate`.

Sigue siempre esta secuencia: modifica el c√≥digo, genera migraciones, apl√≠calas y
valida. As√≠ evitar√°s errores 500 en los flujos de autenticaci√≥n.
