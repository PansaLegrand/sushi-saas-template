---
title: Stripe セットアップ
icon: "CreditCard"
description: Stripe Checkout を使った決済と、Webhook によるクレジット付与の最終確定。環境変数、セッション作成、コールバック処理、署名付き Webhook の扱いを解説します。
keywords:
  - Stripe
  - Checkout
  - Webhook
  - 決済
  - クレジット
  - Next.js
  - 請求
tags: [Stripe, 決済, webhook]
author: "Pansa Legrand"
publishedAt: "2025-09-29T00:00:00.000Z"
updatedAt: "2025-09-29T00:00:00.000Z"
canonical: "https://sushi-saas-template.io/ja/blogs/stripe-setup"
---

## 概要

このテンプレートは Stripe Checkout で決済し、支払い後にクレジット残高を付与します。

- UI: `/[locale]/pricing` は TypeScript の設定からプランを表示。
- セッション作成: `POST /api/checkout` → Stripe にリダイレクト。
- リダイレクト: 成功後に `/api/pay/callback/stripe` (GET)。
- 最終反映: Stripe の Webhook が `/api/pay/webhook/stripe` (POST) に届き、注文を `paid` にしてクレジットを付与。

ソース・オブ・トゥルースは Webhook です。コールバックは画面遷移のみ。

---

## エンドポイント

- `/api/checkout` (POST): `src/data/pricing.ts` を元に検証し、Checkout セッションを作成、注文を `created` で保存。
- `/api/pay/callback/stripe` (GET): Stripe からのリダイレクト用。最終処理は行いません。
- `/api/pay/webhook/stripe` (POST): 署名検証後、`checkout.session.completed` を処理して付与。

---

## クレジットの流れ

1) セッションのメタデータから `order_no` を取得。
2) 注文を `paid` に更新し、決済情報を保存。
3) `credits` に正の行を追加（`order_pay`）。

---

## 必要な環境変数

```bash
STRIPE_PRIVATE_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...
NEXT_PUBLIC_WEB_URL=http://localhost:3000
NEXT_PUBLIC_PAY_CANCEL_URL=/pricing
NEXT_PUBLIC_PAY_SUCCESS_URL=/pricing
NEXT_PUBLIC_PAY_FAIL_URL=/pricing
```

---

## ローカル Webhook 設定

```bash
stripe login
stripe listen --forward-to localhost:3000/api/pay/webhook/stripe
# 表示された whsec を .env に設定
stripe trigger checkout_session_completed
```

---

## 動作確認

1) サインアップ/ログイン。
2) `/[locale]/pricing` でプランを選択。
3) テストカード `4242 4242 4242 4242` で決済。
4) Webhook が注文確定とクレジット付与を実行。
5) `/[locale]/credits-test` で残高を確認。

---

## 実装メモ

- プラン: `src/data/pricing.ts` に定義（型安全）。
- `handleCheckoutSession` は一括・サブスク両対応（サブスクは最新請求書から PaymentIntent を取得）。

## 請求とサブスクリプション

### カスタマーポータル

Stripe の Customer Portal を有効化し、顧客が行える操作（解約/再開、カード更新、請求書閲覧）を設定します。

本テンプレートには以下を用意しています：

- API: `GET /api/billing/portal` — ポータルセッションを作成して Stripe にリダイレクト
- UI: `/:locale/account/billing` — 「Manage billing」ボタンでポータルを開く

実装箇所：

- API ルート: `src/app/api/billing/portal/route.ts`
  - ログイン中ユーザーのメールで Stripe Customer を検索/作成
  - `return_url` を `/:locale/account/billing` に設定

UI（Server Component）：

- `src/app/[locale]/account/billing/page.tsx` から `/api/billing/portal?locale=<locale>` へリンク

### 督促（支払い失敗）

Webhook `invoice.payment_failed` で、支払い方法の更新を促すメール（Resend）を送信します。

- テンプレート: `src/services/email/templates/payment-failed.tsx`
- 送信関数: `sendPaymentFailedEmail()`（`src/services/email/send.ts`）
- Webhook 実装: `src/app/api/pay/webhook/stripe/route.ts`

Stripe CLI でのテスト：

```bash
stripe trigger invoice_payment_failed
```

備考：メールに `/:locale/account/billing` へのリンクを含め、アプリからポータルを開けます。

---

## 製品と価格（Stripe）

Stripe は「販売するもの（製品）」と「価格設定（価格）」を分離しています：

- 製品（`prod_...`）：名称・説明、カタログ用メタデータ。1つの製品に複数の価格が紐づきます。
- 価格（`price_...`）：通貨、金額、課金間隔（毎月/毎年）、トライアル、税設定、ティアなど。サブスクは価格に紐づきます。

Checkout で価格 ID を使う理由

- サブスクには正確な課金条件が必要です。`price_...` に紐づけることで、更新課金、按分、トライアル、Stripe Tax が正しく機能します。
- 更新時の請求書行にも同じ `price_...` が入り、Webhook がプランを特定して各サイクルでクレジットを付与できます。
- 一時的なインライン価格より安全で運用しやすい：金額やルールは Stripe 側で管理し、コードは安定します。

Stripe で価格 ID を見つける手順

1) ダッシュボード → 製品 → 対象の製品を選択。
2) 価格テーブルの行末「︙」(三点) をクリック → 「価格 ID をコピー」。
3) `price_...` で始まります。`prod_...`（製品 ID）と混同しないでください。

環境変数（任意だが推奨）

```bash
# プランと Stripe 価格をマッピング。空ならインライン price_data にフォールバック
NEXT_PUBLIC_STRIPE_PRICE_LAUNCH_MONTHLY=price_...
NEXT_PUBLIC_STRIPE_PRICE_SCALE_MONTHLY=price_...
NEXT_PUBLIC_STRIPE_PRICE_LAUNCH_YEARLY=price_...
NEXT_PUBLIC_STRIPE_PRICE_SCALE_YEARLY=price_...
# CNY 価格（任意）
NEXT_PUBLIC_STRIPE_PRICE_LAUNCH_MONTHLY_CNY=price_...
NEXT_PUBLIC_STRIPE_PRICE_SCALE_MONTHLY_CNY=price_...
NEXT_PUBLIC_STRIPE_PRICE_LAUNCH_YEARLY_CNY=price_...
NEXT_PUBLIC_STRIPE_PRICE_SCALE_YEARLY_CNY=price_...
```

価格 ID の有無による動作

- サブスクプランに Price ID があれば、Checkout はそれを直接使用します。
- 無い場合は、`src/data/pricing.ts` の金額でインライン `price_data` を使ってセッションを作成します（安全なフォールバック）。

---

## 更新（リニューアル）とクレジット

本テンプレートは更新時のクレジット自動付与に対応しています：

- Webhook `invoice.payment_succeeded`（`billing_reason=subscription_cycle` の場合）で、当該期間の更新注文を作成し、プランのクレジットを付与します。
- 冪等性：同一 `(subscription_id, period_start)` の注文が既にあればスキップします。
- 初回購入は引き続き `checkout.session.completed` で処理します。二重付与を避けるため、サイクル外の請求書は無視します。

---

## リマインダー：テスト時は Webhook 転送を設定

ローカル（または本番以外）での検証では、Stripe のイベントを必ずバックエンドに転送してください。そうしないと支払いは成功しても、注文/クレジットが確定しません。

```bash
stripe listen --forward-to localhost:3000/api/pay/webhook/stripe
```

トンネル/リモート URL を利用する場合は、localhost の代わりにそのドメインを指定してください。
