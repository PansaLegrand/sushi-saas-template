# Repository Guidelines

## Project Structure & Module Organization
- `src/app`: Next.js App Router with localized `[locale]` routes, API handlers under `api/`, and global layouts.
- `src/i18n`, `messages/`, `content/docs/`: Locale config, translation catalogs, and Fumadocs MDX; keep locales aligned across all three.
- `src/lib`, `src/services`, `src/models`: Shared utilities, external integrations, and domain types reused by pages and APIs.
- `src/services/storage`: S3‑compatible storage adapter (S3/R2/MinIO) and helpers.
- `src/models/file.ts`: File CRUD for the `files` table.
- `src/db`: Drizzle schema, config, and migrations powering Better Auth; regenerate and migrate before touching auth flows.
- `public/` contains static assets; `.source/` is generated by Fumadocs—do not edit by hand.

## Build, Test, and Development Commands
- `pnpm install`: Install dependencies; run on first clone or when lockfile changes.
- `pnpm dev` / `pnpm dev:webpack`: Start the dev server (Turbopack or Webpack) after regenerating MDX sources.
- `pnpm build` then `pnpm start`: Production build and runtime smoke test; both must succeed before opening a PR.
- `pnpm lint`: Execute `next lint`; warnings are treated as blockers.
- `pnpm drizzle-kit <generate|migrate> --config src/db/config.ts`: Keep database migrations synchronized with `src/db/schema.ts`.
  - The `files` table powers uploads; regenerate and migrate when touching storage schema.

## Coding Style & Naming Conventions
- TypeScript-first; prefer named exports and React Server Components unless client-only APIs force `"use client"`.
- Compose UI with functional components, Tailwind utilities, and co-locate reusable pieces under `src/components`.
- Files stay kebab-case (`auth-screen.tsx`); colocate feature helpers and avoid deep relative imports—use `@/` alias instead.
- Run `pnpm lint` before pushing; enable ESLint and Tailwind IntelliSense in your editor for consistent output.
 - Storage adapters: do not hardcode provider specifics in routes; extend `StorageAdapter` and select via `getStorageAdapter()`.

## Testing Guidelines
- No dedicated test runner yet; lint, type-check, and `pnpm build` are the current gates. When adding automated tests, colocate `*.test.ts[x]` beside the feature and add the command to `package.json`.
- For auth or i18n work, verify at least one happy-path call (e.g., `/api/health` or a localized landing page) and document the manual check in the PR.
 - For storage, verify the minimal flow end‑to‑end:
   1) `POST /api/storage/uploads` returns a presigned URL
   2) PUT bytes to the returned URL
   3) `POST /api/storage/uploads/complete` marks the row `active`
   4) `GET /api/storage/files/[uuid]?download=1` returns a signed download URL
   5) `DELETE /api/storage/files/[uuid]` soft‑deletes and removes the object

## Commit & Pull Request Guidelines
- Follow Conventional Commits (`feat:`, `fix:`, `chore:`) as reflected in recent history.
- Keep commits focused; call out migrations, new env vars, or breaking config changes in the body.
- PRs must include a summary, validation notes (`pnpm lint`, `pnpm build`, migrations), linked issues, and UI screenshots when applicable.
- Request owner review for changes touching `src/app/api` or `src/db` because they affect deployments and authentication.
 - Changes to storage adapters (`src/services/storage/*`) or `files` schema must call out required env vars, CORS rules, and any backward‑compat constraints (e.g., key format).

## Security & Configuration Tips
- Store secrets in `.env` using `.env.example` as the template; never commit real credentials.
- Ensure `BETTER_AUTH_SECRET`, `DATABASE_URL`, and `NEXT_PUBLIC_AUTH_BASE_URL` are set before running dev servers or migrations.
 - Storage env (document in PRs when touched):
   - `STORAGE_PROVIDER`, `STORAGE_BUCKET`, `STORAGE_REGION`, `STORAGE_ENDPOINT`
   - `STORAGE_ACCESS_KEY`, `STORAGE_SECRET_KEY`, `S3_FORCE_PATH_STYLE`, `STORAGE_MAX_UPLOAD_MB`
   - Optional client hint: `NEXT_PUBLIC_UPLOAD_MAX_MB`
 - Keep objects private by default; only expose short‑lived presigned URLs. Never leak raw credentials to client code.
